@model List<EmPeKa.Frontend.Models.ArrivalItem>
@inject IConfiguration Configuration
@{
    ViewData["Title"] = "Odjazdy";
    var basePath = Configuration.GetValue<string>("BasePath") ?? string.Empty;
}

<div class="fullscreen">
    <div class="header">
        <div class="timestamp">@DateTime.Now.ToString("dd.MM.yyyy HH:mm:ss")</div>
        <div class="stop-name">Odjazdy</div>
    </div>

    <div class="arrivals">
        @if (Model == null || Model.Count == 0)
        {
            <div class="empty">Brak nadchodzących odjazdów.</div>
        }
        else
        {
            <div class="arrival-row" style="font-weight:bold; text-transform:uppercase; color: white; background: black; font-family: Segoe UI, Roboto, Arial, sans-serif">
                <div class="line">LINIA</div>
                <div class="direction">KIERUNEK</div>
                <div class="eta">PLANOWO</div>
                <div class="eta">ODJAZD</div>
            </div>
            @foreach (var a in Model)
            {
                <div class="arrival-row @(a.IsRealTime ? "rt" : "tt")">
                    <div class="line">@a.Line</div>
                    <div class="direction">@a.Direction</div>
                    <div class="eta">@a.ScheduledDeparture?.Substring(0, 5)</div>
                    <div class="eta">@a.EtaMin min</div>
                </div>
            }
        }
    </div>
</div>

<style>
    :root { color-scheme: dark; }
    html, body { height: 100%; }
    body { margin: 0; color: #ff8c00; }
    .container { max-width: 100% !important; padding: 0 !important; }
    .fullscreen { display: flex; flex-direction: column; min-height: 100vh; background: #0a0a0a; border-style: solid; border-color: black; border-width: 50px 50px; box-sizing: border-box; }
    .header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 1.5rem; }
    .stop-name { font-size: 2.5rem; }
    .timestamp { font-size: 3rem; font-weight: 700 }
    .arrivals { display: flex; flex-direction: column; gap: 1rem; }
    .arrival-row { display: grid; grid-template-columns: 120px 1fr 200px 200px; align-items: center; padding: 1rem; }
    .arrival-row:first-child { position: sticky; top: 0; z-index: 10; }
    .line { font-size: 2rem }
    .direction { font-size: 2rem; }
    .eta { font-size: 2rem; text-align: right; }
    .empty { font-size: 2rem; opacity: 0.8; }
</style>

<script>
const basePath = @Json.Serialize(basePath);
const urlParams = new URLSearchParams(window.location.search);
const stopCodes = urlParams.getAll('stopCode');
const count = urlParams.get('count');

async function updateBatchArrivals() {
    try {
        let url = `${basePath}/Home?`;
        stopCodes.forEach(code => {
            url += `stopCode=${encodeURIComponent(code)}&`;
        });
        if (count) {
            url += `count=${count}&`;
        }
        url += 'partial=true';

        const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const parser = new DOMParser();
        const htmlDoc = parser.parseFromString(await response.text(), 'text/html');
        const arrivals = htmlDoc.querySelector('.arrivals');
        const arrivalsContainer = document.querySelector('.arrivals');
        if (arrivals && arrivalsContainer) {
            arrivalsContainer.innerHTML = arrivals.innerHTML;
        }

        const timestampEl = document.querySelector('.timestamp');
        if (timestampEl) {
            const now = new Date();
            const dateStr = now.toLocaleDateString('pl-PL', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            const timeStr = now.toLocaleTimeString('pl-PL', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            timestampEl.textContent = `${dateStr} ${timeStr}`;
        }
    } catch (error) {
        console.error('Błąd podczas pobierania danych:', error);
    }
}

setInterval(updateBatchArrivals, 30000);

document.addEventListener('DOMContentLoaded', function() {
    const timestampEl = document.querySelector('.timestamp');
    if (timestampEl) {
        timestampEl.style.cursor = 'pointer';
        timestampEl.title = 'Kliknij aby odświeżyć dane';
        timestampEl.addEventListener('click', updateBatchArrivals);
    }
});
</script>
